<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Event Email Parser</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100">
  <div class="container mx-auto p-4 md:p-6 max-w-6xl">
    <div class="bg-white rounded-2xl shadow-xl p-6 md:p-8 mb-6">
      <h1 class="text-2xl md:text-3xl font-bold text-gray-800 mb-2 flex items-center gap-3">
        <svg class="text-indigo-600" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
          <line x1="16" y1="2" x2="16" y2="6"></line>
          <line x1="8" y1="2" x2="8" y2="6"></line>
          <line x1="3" y1="10" x2="21" y2="10"></line>
        </svg>
        Event Email Parser
      </h1>
      <p class="text-gray-600 mb-6">Paste email content and AI will extract event details</p>

      <textarea
        id="emailInput"
        placeholder="Paste your email content here..."
        class="w-full h-64 p-4 border-2 border-gray-200 rounded-lg focus:border-indigo-500 focus:outline-none font-mono text-sm resize-y"
      ></textarea>

      <div id="errorBox" class="hidden mt-4 p-4 bg-red-50 border border-red-200 rounded-lg text-red-700"></div>
      <div id="debugBox" class="hidden mt-4 p-4 bg-yellow-50 border border-yellow-200 rounded-lg text-yellow-800 text-sm font-mono overflow-x-auto whitespace-pre-wrap"></div>

      <button
        id="parseBtn"
        class="mt-4 px-8 py-3 bg-indigo-600 text-white rounded-lg font-semibold hover:bg-indigo-700 disabled:bg-gray-400 disabled:cursor-not-allowed flex items-center gap-2 transition-colors"
      >
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
          <polyline points="14 2 14 8 20 8"></polyline>
        </svg>
        Extract Events
      </button>
    </div>

    <div id="eventsContainer" class="space-y-4"></div>
  </div>

  <script>
    const parseBtn = document.getElementById('parseBtn');
    const emailInput = document.getElementById('emailInput');
    const errorBox = document.getElementById('errorBox');
    const debugBox = document.getElementById('debugBox');
    const eventsContainer = document.getElementById('eventsContainer');

    parseBtn.addEventListener('click', async () => {
      const emailText = emailInput.value.trim();
      
      if (!emailText) {
        showError('Please paste some email content first');
        return;
      }

      setLoading(true);
      hideError();
      hideDebug();

      try {
        // Call our secure backend proxy instead of Gemini API directly
        const response = await fetch('/api/extract-events', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            emailText: emailText
          })
        });

        showDebug(`Status: ${response.status}, Reading response...`);

        if (!response.ok) {
          const errorData = await response.json();
          throw new Error(`API Error: ${errorData.error || response.statusText}`);
        }

        const data = await response.json();
        const content = data.candidates[0].content.parts[0].text;
        const cleanContent = content.replace(/```json|```/g, '').trim();
        const events = JSON.parse(cleanContent);

        displayEvents(Array.isArray(events) ? events : [events]);
        hideDebug();
      } catch (err) {
        showError(`Failed: ${err.message}`);
        showDebug(`Error: ${err.toString()}`);
      } finally {
        setLoading(false);
      }
    });

    function setLoading(loading) {
      parseBtn.disabled = loading;
      parseBtn.innerHTML = loading ? 
        '<svg class="animate-spin" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="2" x2="12" y2="6"></line><line x1="12" y1="18" x2="12" y2="22"></line><line x1="4.93" y1="4.93" x2="7.76" y2="7.76"></line><line x1="16.24" y1="16.24" x2="19.07" y2="19.07"></line><line x1="2" y1="12" x2="6" y2="12"></line><line x1="18" y1="12" x2="22" y2="12"></line><line x1="4.93" y1="19.07" x2="7.76" y2="16.24"></line><line x1="16.24" y1="7.76" x2="19.07" y2="4.93"></line></svg> Parsing...' :
        '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline></svg> Extract Events';
    }

    function showError(msg) {
      errorBox.textContent = msg;
      errorBox.classList.remove('hidden');
    }

    function hideError() {
      errorBox.classList.add('hidden');
    }

    function showDebug(msg) {
      debugBox.textContent = msg;
      debugBox.classList.remove('hidden');
    }

    function hideDebug() {
      debugBox.classList.add('hidden');
    }

    function displayEvents(events) {
      if (events.length === 0) {
        eventsContainer.innerHTML = '<p class="text-gray-600">No events found</p>';
        return;
      }

      eventsContainer.innerHTML = `
        <h2 class="text-2xl font-bold text-gray-800 mb-4">Found ${events.length} Event${events.length > 1 ? 's' : ''}</h2>
        ${events.map(event => `
          <div class="bg-white rounded-xl shadow-lg p-6 hover:shadow-xl transition-shadow">
            <div class="flex flex-col md:flex-row md:justify-between md:items-start gap-4 mb-4">
              <h3 class="text-xl font-bold text-gray-800">${event.title}</h3>
              <div class="flex flex-wrap gap-2">
                <button onclick="addToGoogleCalendar(${JSON.stringify(event).replace(/"/g, '&quot;')})" class="px-4 py-2 bg-blue-600 text-white rounded-lg font-semibold hover:bg-blue-700 flex items-center gap-2 transition-colors whitespace-nowrap text-sm">
                  <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>
                  Google Calendar
                </button>
                <button onclick="downloadICS(${JSON.stringify(event).replace(/"/g, '&quot;')})" class="px-4 py-2 bg-green-600 text-white rounded-lg font-semibold hover:bg-green-700 flex items-center gap-2 transition-colors whitespace-nowrap text-sm">
                  <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>
                  Download .ics
                </button>
              </div>
            </div>
            <div class="space-y-3">
              <div class="flex items-center gap-3 text-gray-700">
                <svg class="text-indigo-600" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>
                <span class="font-medium">${event.date}</span>
                ${event.time ? `
                  <svg class="text-indigo-600 ml-4" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg>
                  <span class="font-medium">${event.time}</span>
                ` : ''}
              </div>
              ${event.location ? `
                <div class="flex items-center gap-3 text-gray-700">
                  <svg class="text-indigo-600" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path><circle cx="12" cy="10" r="3"></circle></svg>
                  <span>${event.location}</span>
                </div>
              ` : ''}
              ${event.url ? `
                <div class="flex items-center gap-3 text-gray-700">
                  <svg class="text-indigo-600" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline></svg>
                  <a href="${event.url}" target="_blank" class="text-indigo-600 hover:text-indigo-800 underline break-all">${event.url}</a>
                </div>
              ` : ''}
              ${event.description ? `
                <div class="mt-4 p-4 bg-gray-50 rounded-lg">
                  <p class="text-gray-700">${event.description}</p>
                </div>
              ` : ''}
            </div>
          </div>
        `).join('')}
      `;
    }

    function addToGoogleCalendar(event) {
      const formatDate = (date, time) => {
        const d = new Date(date);
        if (time) {
          const [h, m] = time.split(':');
          d.setHours(parseInt(h), parseInt(m));
        }
        return d.toISOString().replace(/[-:]/g, '').split('.')[0] + 'Z';
      };

      const start = formatDate(event.date, event.time || '00:00');
      const end = formatDate(event.date, event.time ? `${parseInt(event.time.split(':')[0]) + 1}:${event.time.split(':')[1]}` : '23:59');
      const details = `${event.description || ''}${event.url ? '\n\nLink: ' + event.url : ''}`;
      
      const url = `https://calendar.google.com/calendar/render?action=TEMPLATE&text=${encodeURIComponent(event.title)}&dates=${start}/${end}&details=${encodeURIComponent(details)}&location=${encodeURIComponent(event.location || '')}`;
      window.open(url, '_blank');
    }

    function downloadICS(event) {
      const formatDate = (date, time) => {
        const d = new Date(date);
        if (time) {
          const [h, m] = time.split(':');
          d.setHours(parseInt(h), parseInt(m));
        }
        return d.toISOString().replace(/[-:]/g, '').split('.')[0] + 'Z';
      };

      const start = formatDate(event.date, event.time || '00:00');
      const end = formatDate(event.date, event.time ? `${parseInt(event.time.split(':')[0]) + 1}:${event.time.split(':')[1]}` : '23:59');

      const ics = `BEGIN:VCALENDAR
VERSION:2.0
PRODID:-//Event Parser//EN
BEGIN:VEVENT
UID:${Date.now()}@eventparser
DTSTAMP:${new Date().toISOString().replace(/[-:]/g, '').split('.')[0]}Z
DTSTART:${start}
DTEND:${end}
SUMMARY:${event.title}
DESCRIPTION:${event.description || ''}${event.url ? '\\n\\nLink: ' + event.url : ''}
LOCATION:${event.location || ''}
${event.url ? `URL:${event.url}` : ''}
END:VEVENT
END:VCALENDAR`;

      const blob = new Blob([ics], { type: 'text/calendar' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `${event.title.replace(/[^a-z0-9]/gi, '_')}.ics`;
      a.click();
      URL.revokeObjectURL(url);
    }
  </script>
</body>
</html>